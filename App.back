import React, { useState, useRef, useEffect, useMemo } from "react";
import "./App.css";
import { supabase } from "./lib/supabaseClient";

/** ç”»é¢ä¸Šéƒ¨ã®ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤ºç”¨ */
type Step = 1 | 2 | 3;

/** Supabase ã® running_analysis_sessions ã®å‹ï¼ˆä½¿ã£ã¦ã„ã‚‹ã‚«ãƒ©ãƒ ã ã‘ï¼‰ */
type RunningAnalysisSession = {
  id: string;
  created_at: string;
  source_video_name: string | null;
  distance_m: number | null;
  frames_count: number | null;
  section_start_frame: number | null;
  section_end_frame: number | null;
  section_frame_count: number | null;
  section_time_s: number | null;
  avg_speed_mps: number | null;
  label: string | null;
  notes: string | null;
  target_fps: number | null;
};

/** æ¥åœ°ï¼é›¢åœ°ãƒãƒ¼ã‚«ãƒ¼ã‹ã‚‰è¨ˆç®—ã—ãŸ 1 æ­©ã”ã¨ã®ãƒ‡ãƒ¼ã‚¿ */
type StepMetric = {
  index: number;
  contactFrame: number; // æ¥åœ°ãƒ•ãƒ¬ãƒ¼ãƒ 
  toeOffFrame: number; // é›¢åœ°ãƒ•ãƒ¬ãƒ¼ãƒ 
  nextContactFrame: number | null; // æ¬¡ã®æ¥åœ°ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆåŒã˜è„šï¼‰
  contactTime: number | null; // æ¥åœ°æ™‚é–“ [s]
  flightTime: number | null; // æ»ç©ºæ™‚é–“ [s]
  stepTime: number | null; // 1 æ­©ã®åˆè¨ˆæ™‚é–“ [s]
  stepPitch: number | null; // ãƒ”ãƒƒãƒ [æ­©/ç§’]
};

const clamp = (v: number, min: number, max: number) =>
  Math.max(min, Math.min(max, v));

const App: React.FC = () => {
  const [step, setStep] = useState<Step>(1);

  // ------------ å‹•ç”»ãƒ»ãƒ•ãƒ¬ãƒ¼ãƒ é–¢é€£ -----------------
  const [videoFile, setVideoFile] = useState<File | null>(null);
  const [videoUrl, setVideoUrl] = useState<string | null>(null);

  const [isExtracting, setIsExtracting] = useState(false);
  const [extractProgress, setExtractProgress] = useState(0);
  const [status, setStatus] = useState<string>("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");

  const framesRef = useRef<ImageData[]>([]);
  const [framesCount, setFramesCount] = useState(0);
  const [currentFrame, setCurrentFrame] = useState(0);

  const videoRef = useRef<HTMLVideoElement | null>(null);
  const canvasRef = useRef<HTMLCanvasElement | null>(null);

  // æŠ½å‡ºã«å®Ÿéš›ã«ä½¿ã£ãŸ fpsï¼ˆ120 ã‚’å¸Œæœ›ã—ã¤ã¤ã€å‹•ç”»é•·ã‹ã‚‰è‡ªå‹•èª¿æ•´ï¼‰
  const [usedTargetFps, setUsedTargetFps] = useState<number | null>(null);

  // è¶³å…ƒæ‹¡å¤§
  const [footZoomEnabled, setFootZoomEnabled] = useState(false);
  // ã©ã®é«˜ã•ã‚’ä¸­å¿ƒã«æ‹¡å¤§ã™ã‚‹ã‹ï¼ˆ0ã€œ1, ä¸‹å¯„ã‚Šã‚’ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ 0.85ï¼‰
  const [zoomCenterRatio, setZoomCenterRatio] = useState(0.85);

  // ------------ åŒºé–“æŒ‡å®šï¼ˆé–‹å§‹ï¼çµ‚äº†ï¼ä¸­é–“ï¼‰ ------------
  const [sectionStartFrame, setSectionStartFrame] = useState<number | null>(
    null
  );
  const [sectionEndFrame, setSectionEndFrame] = useState<number | null>(null);
  const [sectionMidFrame, setSectionMidFrame] = useState<number | null>(null); // å‰åŠï¼å¾ŒåŠã®å¢ƒç›®ãªã©ã«åˆ©ç”¨

  // åŒºé–“ã®å®Ÿéš›ã®å€¤ï¼ˆnull ã®ã¨ãã¯ 0ã€œæœ€å¾Œã«è‡ªå‹•è£œå®Œï¼‰
  const sectionRange = useMemo(() => {
    const start = sectionStartFrame ?? 0;
    const end =
      sectionEndFrame ??
      (framesRef.current.length > 0 ? framesRef.current.length - 1 : 0);
    const count = end >= start ? end - start + 1 : 0;
    return { start, end, count };
  }, [sectionStartFrame, sectionEndFrame, framesCount]);

  // åŒºé–“æ™‚é–“
  const sectionTime =
    usedTargetFps && sectionRange.count > 0
      ? sectionRange.count / usedTargetFps
      : null;

  // ------------ è·é›¢ãƒ»é€Ÿåº¦ãƒ»ãƒ©ãƒ™ãƒ«ãªã© ---------------
  const [distanceInput, setDistanceInput] = useState<string>("10"); // [m]
  const [labelInput, setLabelInput] = useState<string>(""); // ã€Œå‰åŠ5mã€ã€Œå¾ŒåŠ5mã€ãªã©
  const [notesInput, setNotesInput] = useState<string>(""); // ãƒ¡ãƒ¢

  const distanceValue = useMemo(() => {
    const d = parseFloat(distanceInput);
    return !isNaN(d) && d > 0 ? d : null;
  }, [distanceInput]);

  const avgSpeed =
    distanceValue != null && sectionTime != null && sectionTime > 0
      ? distanceValue / sectionTime
      : null;

  // ------------ æ¥åœ°ï¼é›¢åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆSpace ã‚­ãƒ¼ï¼‰ ------------
  // Space ã‚’æŠ¼ã™ãŸã³ã« currentFrame ã‚’é…åˆ—ã«ä¿å­˜
  // å¥‡æ•°å›ç›®: æ¥åœ°, å¶æ•°å›ç›®: é›¢åœ° ã¨ã—ã¦æ‰±ã†
  const [contactFrames, setContactFrames] = useState<number[]>([]);

  // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œï¼ˆâ† â†’ â†‘ â†“ ã¨ Spaceï¼‰
  useEffect(() => {
    const handleKeyDown = (e: KeyboardEvent) => {
      if (!framesCount) return;

      if (e.code === "Space") {
        e.preventDefault();
        setContactFrames((prev) => [...prev, currentFrame]);
        return;
      }

      if (e.code === "ArrowRight") {
        e.preventDefault();
        setCurrentFrame((prev) =>
          clamp(prev + 1, 0, Math.max(0, framesRef.current.length - 1))
        );
      } else if (e.code === "ArrowLeft") {
        e.preventDefault();
        setCurrentFrame((prev) =>
          clamp(prev - 1, 0, Math.max(0, framesRef.current.length - 1))
        );
      } else if (e.code === "ArrowUp") {
        e.preventDefault();
        setCurrentFrame((prev) =>
          clamp(prev + 10, 0, Math.max(0, framesRef.current.length - 1))
        );
      } else if (e.code === "ArrowDown") {
        e.preventDefault();
        setCurrentFrame((prev) =>
          clamp(prev - 10, 0, Math.max(0, framesRef.current.length - 1))
        );
      }
    };

    window.addEventListener("keydown", handleKeyDown);
    return () => window.removeEventListener("keydown", handleKeyDown);
  }, [currentFrame, framesCount]);

  const handleClearMarkers = () => {
    setContactFrames([]);
  };

  // ------------ æ¥åœ°ï¼é›¢åœ°ãƒãƒ¼ã‚«ãƒ¼ã‹ã‚‰ 1 æ­©ã”ã¨ã®è§£æ ------------
  const stepMetrics: StepMetric[] = useMemo(() => {
    if (!usedTargetFps) return [];
    if (contactFrames.length < 3) return []; // æ¥åœ°â†’é›¢åœ°â†’æ¬¡ã®æ¥åœ° ã§æœ€ä½ 3 ç‚¹å¿…è¦

    const metrics: StepMetric[] = [];
    // contactFrames: [æ¥åœ°1, é›¢åœ°1, æ¥åœ°2, é›¢åœ°2, æ¥åœ°3, ...]
    for (let i = 0; i + 2 < contactFrames.length; i += 2) {
      const contact = contactFrames[i];
      const toeOff = contactFrames[i + 1];
      const nextContact = contactFrames[i + 2];

      const contactTime =
        toeOff > contact ? (toeOff - contact) / usedTargetFps : null;
      const flightTime =
        nextContact > toeOff ? (nextContact - toeOff) / usedTargetFps : null;
      const stepTime =
        nextContact > contact ? (nextContact - contact) / usedTargetFps : null;
      const stepPitch = stepTime && stepTime > 0 ? 1 / stepTime : null;

      metrics.push({
        index: metrics.length + 1,
        contactFrame: contact,
        toeOffFrame: toeOff,
        nextContactFrame: nextContact ?? null,
        contactTime,
        flightTime,
        stepTime,
        stepPitch,
      });
    }
    return metrics;
  }, [contactFrames, usedTargetFps]);

  const stepSummary = useMemo(() => {
    if (!stepMetrics.length) {
      return {
        stepCount: 0,
        avgContact: null as number | null,
        avgFlight: null as number | null,
        avgStepTime: null as number | null,
        avgStepPitch: null as number | null,
        avgStride: null as number | null,
      };
    }

    let sumContact = 0;
    let nContact = 0;
    let sumFlight = 0;
    let nFlight = 0;
    let sumStep = 0;
    let nStep = 0;
    let sumPitch = 0;
    let nPitch = 0;

    for (const s of stepMetrics) {
      if (s.contactTime != null) {
        sumContact += s.contactTime;
        nContact++;
      }
      if (s.flightTime != null) {
        sumFlight += s.flightTime;
        nFlight++;
      }
      if (s.stepTime != null) {
        sumStep += s.stepTime;
        nStep++;
      }
      if (s.stepPitch != null) {
        sumPitch += s.stepPitch;
        nPitch++;
      }
    }

    const stepCount = nStep;

    const avgContact = nContact ? sumContact / nContact : null;
    const avgFlight = nFlight ? sumFlight / nFlight : null;
    const avgStepTime = nStep ? sumStep / nStep : null;
    const avgStepPitch = nPitch ? sumPitch / nPitch : null;

    // ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã®å¹³å‡ï¼šåŒºé–“è·é›¢ Ã· æ­©æ•°ï¼ˆã‚ãã¾ã§åŒºé–“å…¨ä½“ã®å¹³å‡ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ï¼‰
    const avgStride =
      distanceValue != null && stepCount > 0
        ? distanceValue / stepCount
        : null;

    return {
      stepCount,
      avgContact,
      avgFlight,
      avgStepTime,
      avgStepPitch,
      avgStride,
    };
  }, [stepMetrics, distanceValue]);

  // ------------ Supabase æ¥ç¶šï¼ä¿å­˜é–¢é€£ ------------
  const [supabaseTestResult, setSupabaseTestResult] = useState<string | null>(
    null
  );
  const [saving, setSaving] = useState(false);
  const [saveResult, setSaveResult] = useState<string | null>(null);
  const [latestSessions, setLatestSessions] = useState<
    RunningAnalysisSession[]
  >([]);
  const [latestDetail, setLatestDetail] =
    useState<RunningAnalysisSession | null>(null);
  const [loadingLatest, setLoadingLatest] = useState(false);

  const fetchLatestSessions = async () => {
    setLoadingLatest(true);
    try {
      const { data, error } = await supabase
        .from("running_analysis_sessions")
        .select(
          "id, created_at, source_video_name, distance_m, frames_count, section_start_frame, section_end_frame, section_frame_count, section_time_s, avg_speed_mps, label, notes, target_fps"
        )
        .order("created_at", { ascending: false })
        .limit(5);

      if (error) throw error;

      const list = (data ?? []) as RunningAnalysisSession[];
      setLatestSessions(list);
      setLatestDetail(list[0] ?? null);
    } catch (e: any) {
      console.error(e);
      setSupabaseTestResult(
        `âŒ æ¥ç¶šã‚¨ãƒ©ãƒ¼: ${e.message ?? String(e)}ï¼ˆæœ€æ–° 5 ä»¶ã®å–å¾—ã«å¤±æ•—ï¼‰`
      );
    } finally {
      setLoadingLatest(false);
    }
  };

  const handleSupabaseTest = async () => {
    setSupabaseTestResult(null);
    await fetchLatestSessions();
    setSupabaseTestResult(
      "âœ… æ¥ç¶šæˆåŠŸï¼ˆrunning_analysis_sessions ãƒ†ãƒ¼ãƒ–ãƒ«ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã—ãŸï¼‰"
    );
  };

  const handleSaveSession = async () => {
    setSaveResult(null);

    const videoName =
      videoFile?.name ??
      latestDetail?.source_video_name ??
      "(åç§°ãªã—ã®å‹•ç”»ã‚»ãƒƒã‚·ãƒ§ãƒ³)";

    const distance_m = distanceValue;
    const section_frame_count =
      sectionRange.count > 0 ? sectionRange.count : null;

    const section_time_s = sectionTime;
    const avg_speed_mps = avgSpeed;

    try {
      setSaving(true);

      const payload = {
        source_video_name: videoName,
        distance_m,
        frames_count: framesCount || null,
        section_start_frame: sectionRange.start,
        section_end_frame: sectionRange.end,
        section_frame_count,
        section_time_s,
        avg_speed_mps,
        target_fps: usedTargetFps,
        label: labelInput || null,
        notes: notesInput || null,
      };

      const { data, error } = await supabase
        .from("running_analysis_sessions")
        .insert(payload)
        .select()
        .single();

      if (error) throw error;

      setSaveResult(
        `âœ… ä¿å­˜æˆåŠŸ: id=${(data as any).id ?? "(ä¸æ˜)"}, å‹•ç”»=${videoName}`
      );
      // æœ€æ–°ä¸€è¦§ã‚’æ›´æ–°
      await fetchLatestSessions();
    } catch (e: any) {
      console.error(e);
      setSaveResult(`âŒ ä¿å­˜ã‚¨ãƒ©ãƒ¼: ${e.message ?? String(e)}`);
    } finally {
      setSaving(false);
    }
  };

  // ------------ ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ & ãƒªã‚»ãƒƒãƒˆ ------------

  const handleFileChange: React.ChangeEventHandler<HTMLInputElement> = (e) => {
    const file = e.target.files?.[0] ?? null;

    if (videoUrl) {
      URL.revokeObjectURL(videoUrl);
      setVideoUrl(null);
    }

    framesRef.current = [];
    setFramesCount(0);
    setCurrentFrame(0);
    setExtractProgress(0);
    setUsedTargetFps(null);
    setStatus("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    setStep(1);
    setSectionStartFrame(null);
    setSectionEndFrame(null);
    setSectionMidFrame(null);
    setContactFrames([]);

    if (file && file.type.startsWith("video/")) {
      const url = URL.createObjectURL(file);
      setVideoFile(file);
      setVideoUrl(url);
      setStatus(`âœ… ${file.name} ãŒé¸æŠã•ã‚Œã¾ã—ãŸã€‚ã€Œãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºã€ã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
    } else {
      setVideoFile(null);
      setStatus("âŒ mp4 ãªã©ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    }
  };

  const handleResetAll = () => {
    if (videoUrl) URL.revokeObjectURL(videoUrl);

    setVideoUrl(null);
    setVideoFile(null);
    framesRef.current = [];
    setFramesCount(0);
    setCurrentFrame(0);
    setExtractProgress(0);
    setIsExtracting(false);
    setUsedTargetFps(null);
    setSectionStartFrame(null);
    setSectionEndFrame(null);
    setSectionMidFrame(null);
    setContactFrames([]);
    setStatus("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
    setStep(1);
  };

  const handleResetSectionRange = () => {
    setSectionStartFrame(null);
    setSectionEndFrame(null);
    setSectionMidFrame(null);
  };

  // ------------ ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºï¼ˆç¸®å°ï¼‹æœ€å¤§ãƒ•ãƒ¬ãƒ¼ãƒ æ•°åˆ¶é™ï¼‰ ------------

  const handleExtractFrames = async () => {
    if (!videoFile || !videoRef.current || !canvasRef.current) {
      alert("å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚");
      return;
    }

    const video = videoRef.current;
    const canvas = canvasRef.current;
    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    if (!ctx) {
      alert("ã‚­ãƒ£ãƒ³ãƒã‚¹ã®åˆæœŸåŒ–ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      return;
    }

    setIsExtracting(true);
    setExtractProgress(0);
    setStatus("å‹•ç”»æƒ…å ±ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...");

    try {
      await new Promise<void>((resolve, reject) => {
        const onLoaded = () => {
          video.removeEventListener("loadedmetadata", onLoaded);
          video.removeEventListener("error", onError);
          resolve();
        };
        const onError = () => {
          video.removeEventListener("loadedmetadata", onLoaded);
          video.removeEventListener("error", onError);
          reject(new Error("å‹•ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚"));
        };

        video.addEventListener("loadedmetadata", onLoaded);
        video.addEventListener("error", onError);

        if (videoUrl) {
          video.src = videoUrl;
        } else {
          const url = URL.createObjectURL(videoFile);
          setVideoUrl(url);
          video.src = url;
        }
      });
    } catch (err) {
      console.error(err);
      setIsExtracting(false);
      setStatus("âŒ å‹•ç”»ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚");
      return;
    }

    if (!video.videoWidth || !video.videoHeight) {
      setIsExtracting(false);
      setStatus("âŒ å‹•ç”»ã‚µã‚¤ã‚ºãŒå–å¾—ã§ãã¾ã›ã‚“ã€‚");
      return;
    }

    const duration = video.duration;

    // ---- ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ä¸Šé™ã‚’æ±ºã‚ã¦ fps ã‚’è‡ªå‹•èª¿æ•´ ----
    const MAX_FRAMES = 1000;
    const preferredFps = 120;
    const maxFpsForLength = Math.floor(MAX_FRAMES / Math.max(duration, 0.001));
    const targetFps = Math.max(30, Math.min(preferredFps, maxFpsForLength));
    const dt = 1 / targetFps;
    const totalFrames = Math.max(1, Math.floor(duration * targetFps));

    setUsedTargetFps(targetFps);

    // è§£åƒåº¦ç¸®å°ï¼ˆæ¨ª 960px ç›®å®‰ ï¼ ä»¥å‰ã‚ˆã‚Šé«˜ç²¾ç´°ï¼‰
    const MAX_WIDTH = 960;
    const scale = Math.min(1, MAX_WIDTH / video.videoWidth);
    const targetWidth = Math.round(video.videoWidth * scale);
    const targetHeight = Math.round(video.videoHeight * scale);

    canvas.width = targetWidth;
    canvas.height = targetHeight;

    framesRef.current = [];
    setFramesCount(0);
    setCurrentFrame(0);

    setStatus(
      `ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºä¸­... é•·ã• ${duration.toFixed(
        2
      )} ç§’, fps â‰’ ${targetFps}ï¼ˆæœ€å¤§ ${MAX_FRAMES} ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰`
    );

    let index = 0;

    const grabFrame = () => {
      if (index >= totalFrames) {
        setIsExtracting(false);
        setExtractProgress(100);
        setFramesCount(framesRef.current.length);
        setCurrentFrame(0);
        setStep(3);
        setStatus(
          `âœ… ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºå®Œäº†ï¼ˆ${framesRef.current.length} ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰ã€‚ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ã¨ã€ŒÂ±1ã€ãƒœã‚¿ãƒ³ã§1ã‚³ãƒãšã¤ç¢ºèªã§ãã¾ã™ã€‚`
        );
        return;
      }

      const currentTime = index * dt;

      const onSeeked = () => {
        video.removeEventListener("seeked", onSeeked);

        requestAnimationFrame(() => {
          ctx.drawImage(video, 0, 0, targetWidth, targetHeight);

          const imageData = ctx.getImageData(0, 0, targetWidth, targetHeight);
          framesRef.current.push(imageData);

          const progress = Math.round(((index + 1) / totalFrames) * 100);
          setExtractProgress(clamp(progress, 0, 99));
          setStatus(
            `ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºä¸­... ${index + 1}/${totalFrames} ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆç´„ ${(currentTime + dt).toFixed(
              2
            )} ç§’ï¼‰`
          );

          index += 1;
          grabFrame();
        });
      };

      video.addEventListener("seeked", onSeeked);
      video.currentTime = clamp(currentTime, 0, duration);
    };

    grabFrame();
  };

  // ------------ ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã®æç”»ï¼ˆè¶³å…ƒæ‹¡å¤§ä»˜ãï¼‰ ------------

  useEffect(() => {
    const canvas = canvasRef.current;
    const frames = framesRef.current;
    if (!canvas || !frames.length) return;

    const ctx = canvas.getContext("2d", { willReadFrequently: true });
    if (!ctx) return;

    const idx = clamp(currentFrame, 0, frames.length - 1);
    const frame = frames[idx];

    const w = frame.width;
    const h = frame.height;

    // ã‚ªãƒ•ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã«ã¾ãšãƒ•ãƒ«ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æç”»
    const offscreen = document.createElement("canvas");
    offscreen.width = w;
    offscreen.height = h;
    const offCtx = offscreen.getContext("2d");
    if (!offCtx) return;
    offCtx.putImageData(frame, 0, 0);

    canvas.width = w;
    canvas.height = h;

    if (!footZoomEnabled) {
      // é€šå¸¸è¡¨ç¤ºï¼šãã®ã¾ã¾
      ctx.drawImage(offscreen, 0, 0, w, h, 0, 0, w, h);
    } else {
      // è¶³å…ƒæ‹¡å¤§è¡¨ç¤ºï¼šç¸¦æ–¹å‘ 1/3 ã®å¸¯ã‚’æ‹¡å¤§ã—ã¦å…¨ç”»é¢ã«
      const zoomHeight = Math.floor(h / 3); // åˆ‡ã‚Šå‡ºã™é«˜ã•
      const centerY = clamp(
        Math.round(h * zoomCenterRatio),
        zoomHeight / 2,
        h - zoomHeight / 2
      );
      const srcY = centerY - Math.floor(zoomHeight / 2);
      const srcX = 0;

      ctx.drawImage(
        offscreen,
        srcX,
        srcY,
        w,
        zoomHeight,
        0,
        0,
        w,
        h
      );
    }
  }, [currentFrame, framesCount, footZoomEnabled, zoomCenterRatio]);

  const ready = framesCount > 0;

  // ------------ ã‚³ãƒé€ã‚Šï¼ˆãƒœã‚¿ãƒ³ç”¨ï¼‰ ------------
  const changeFrame = (delta: number) => {
    if (!ready) return;
    const newFrame = clamp(
      currentFrame + delta,
      0,
      Math.max(0, framesRef.current.length - 1)
    );
    setCurrentFrame(newFrame);
  };

  const handleSliderChange: React.ChangeEventHandler<HTMLInputElement> = (e) => {
    if (!ready) return;
    const idx = Number(e.target.value) || 0;
    setCurrentFrame(idx);
  };

  const currentLabel = ready ? currentFrame + 1 : 0;
  const maxLabel = ready ? framesCount : 0;

  // ------------ JSX ------------

  return (
    <div className="app-root">
      <header className="app-header">
        <h1>ğŸƒâ€â™‚ï¸ ãƒ©ãƒ³ãƒ‹ãƒ³ã‚°å‹•ç”»è§£æãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆPhase 2ï¼‰</h1>
        <p className="app-subtitle">
          Step1: å‹•ç”»èª­ã¿è¾¼ã¿ â†’ Step2: ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º â†’ Step3: ã‚³ãƒé€ã‚Šï¼†è§£æ
          <br />
          â€» â†/â†’: Â±1 ã‚³ãƒ, â†‘/â†“: Â±10 ã‚³ãƒ, Space: æ¥åœ°/é›¢åœ°ãƒãƒ¼ã‚¯
        </p>
      </header>

      {/* ã‚¹ãƒ†ãƒƒãƒ—è¡¨ç¤º */}
      <div className="step-indicator-row">
        <div className={`step-badge ${step >= 1 ? "active" : ""}`}>
          <span className="step-number">1</span>å‹•ç”»èª­ã¿è¾¼ã¿
        </div>
        <div className={`step-badge ${step >= 2 ? "active" : ""}`}>
          <span className="step-number">2</span>ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡º
        </div>
        <div className={`step-badge ${step >= 3 ? "active" : ""}`}>
          <span className="step-number">3</span>ãƒ•ãƒ¬ãƒ¼ãƒ ç¢ºèªï¼†è§£æ
        </div>
      </div>

      <main className="main-layout">
        {/* å·¦å´ï¼šå‹•ç”»ãƒ»ã‚­ãƒ£ãƒ³ãƒã‚¹ */}
        <section className="left-panel">
          <div className="control-row">
            <label className="file-button">
              ğŸ¥ å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
              <input type="file" accept="video/*" onChange={handleFileChange} />
            </label>
            <button
              className="primary-button"
              onClick={handleExtractFrames}
              disabled={!videoFile || isExtracting}
            >
              â–¶ ãƒ•ãƒ¬ãƒ¼ãƒ æŠ½å‡ºï¼ˆé«˜ç²¾ç´°ï¼‰
            </button>
            <button className="ghost-button" onClick={handleResetAll}>
              ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>

          <div className="status-row">
            <span>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: {status}</span>
            {isExtracting && (
              <span className="status-progress">
                æŠ½å‡ºé€²æ—: {extractProgress}%
              </span>
            )}
          </div>

          <div className="foot-zoom-row">
            <button
              className={footZoomEnabled ? "toggle-button on" : "toggle-button"}
              onClick={() => setFootZoomEnabled((v) => !v)}
            >
              è¶³å…ƒæ‹¡å¤§ {footZoomEnabled ? "ON" : "OFF"}
            </button>
            <label className="zoom-slider-label">
              æ‹¡å¤§ä½ç½®ï¼ˆç¸¦ï¼‰:
              <input
                type="range"
                min={50}
                max={100}
                value={Math.round(zoomCenterRatio * 100)}
                onChange={(e) =>
                  setZoomCenterRatio(Number(e.target.value) / 100)
                }
              />
              <span>{Math.round(zoomCenterRatio * 100)}%</span>
            </label>
          </div>

          {/* ã‚­ãƒ£ãƒ³ãƒã‚¹ */}
          <div className="canvas-wrapper">
            <canvas ref={canvasRef} className="video-canvas" />
          </div>

          {/* ãƒ•ãƒ¬ãƒ¼ãƒ ã‚¹ãƒ©ã‚¤ãƒ€ãƒ¼ */}
          <div className="slider-section">
            <div className="slider-label">
              ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ : {currentLabel}/{maxLabel}
            </div>
            <input
              type="range"
              min={0}
              max={Math.max(ready ? framesCount - 1 : 0, 0)}
              step={1}
              value={ready ? currentFrame : 0}
              onChange={handleSliderChange}
              disabled={!ready}
              className="frame-slider"
            />
            <div className="frame-buttons">
              <button onClick={() => changeFrame(-10)} disabled={!ready}>
                -10
              </button>
              <button onClick={() => changeFrame(-1)} disabled={!ready}>
                -1
              </button>
              <button onClick={() => changeFrame(1)} disabled={!ready}>
                +1
              </button>
              <button onClick={() => changeFrame(10)} disabled={!ready}>
                +10
              </button>
            </div>
          </div>

          {/* åŒºé–“æŒ‡å®š */}
          <div className="section-range-row">
            <div>
              åŒºé–“é–‹å§‹ãƒ•ãƒ¬ãƒ¼ãƒ :{" "}
              {sectionStartFrame != null ? sectionStartFrame : 0}{" "}
              <button
                onClick={() => setSectionStartFrame(currentFrame)}
                disabled={!ready}
              >
                ğŸ‘‰ ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’é–‹å§‹ã«
              </button>
            </div>
            <div>
              åŒºé–“çµ‚äº†ãƒ•ãƒ¬ãƒ¼ãƒ :{" "}
              {sectionEndFrame != null
                ? sectionEndFrame
                : Math.max(framesCount - 1, 0)}{" "}
              <button
                onClick={() => setSectionEndFrame(currentFrame)}
                disabled={!ready}
              >
                ğŸ‘‰ ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’çµ‚äº†ã«
              </button>
            </div>
            <div>
              ä¸­é–“ãƒ•ãƒ¬ãƒ¼ãƒ ï¼ˆä»»æ„ï¼‰:{" "}
              {sectionMidFrame != null ? sectionMidFrame : "ãƒ¼"}{" "}
              <button
                onClick={() => setSectionMidFrame(currentFrame)}
                disabled={!ready}
              >
                ğŸ‘‰ ç¾åœ¨ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ä¸­é–“ã«
              </button>
            </div>
            <button
              className="ghost-button"
              onClick={handleResetSectionRange}
              disabled={!ready}
            >
              åŒºé–“ã‚’å…¨ä½“ï¼ˆ0ã€œæœ€å¾Œï¼‰ã«ãƒªã‚»ãƒƒãƒˆ
            </button>
          </div>
        </section>

        {/* å³å´ï¼šè§£æãƒ‘ãƒãƒ« */}
        <section className="right-panel">
          <h2>ç°¡æ˜“è§£æï¼ˆã“ã®åŒºé–“ã®è·é›¢ã¨é€Ÿåº¦ï¼‰</h2>
          <div className="analysis-box">
            <label className="field-row">
              <span>è·é›¢ [m]</span>
              <input
                type="number"
                min={0}
                step={0.1}
                value={distanceInput}
                onChange={(e) => setDistanceInput(e.target.value)}
              />
            </label>
            <div className="field-row">
              <span>å…¨ä½“ãƒ•ãƒ¬ãƒ¼ãƒ æ•°</span>
              <span>{framesCount || "ãƒ¼"}</span>
            </div>
            <div className="field-row">
              <span>ä½¿ç”¨ fps</span>
              <span>{usedTargetFps ?? "ãƒ¼"}</span>
            </div>
            <div className="field-row">
              <span>åŒºé–“</span>
              <span>
                {sectionRange.start}ã€œ{sectionRange.end} ãƒ•ãƒ¬ãƒ¼ãƒ 
              </span>
            </div>
            <div className="field-row">
              <span>åŒºé–“æ™‚é–“ [s]</span>
              <span>
                {sectionTime != null ? sectionTime.toFixed(3) : "ãƒ¼"}
              </span>
            </div>
            <div className="field-row">
              <span>å¹³å‡é€Ÿåº¦ [m/s]</span>
              <span>{avgSpeed != null ? avgSpeed.toFixed(3) : "ãƒ¼"}</span>
            </div>
          </div>

          <h3>ãƒ•ã‚©ãƒ¼ãƒ ã®ç‰¹å¾´ãªã©</h3>
          <div className="notes-box">
            <textarea
              value={notesInput}
              onChange={(e) => setNotesInput(e.target.value)}
              placeholder="ãƒ•ã‚©ãƒ¼ãƒ ã®å°è±¡ãƒ»ä¿®æ­£ãƒã‚¤ãƒ³ãƒˆãªã©ãƒ¡ãƒ¢"
            />
          </div>

          <h3>æ¥åœ°ï¼é›¢åœ°ãƒãƒ¼ã‚«ãƒ¼ï¼ˆSpace ã‚­ãƒ¼ï¼‰</h3>
          <p>
            å‹•ç”»ã‚’ã‚³ãƒé€ã‚Šã—ãªãŒã‚‰ã€æ¥åœ°ã§ Spaceã€é›¢åœ°ã§ Spaceâ€¦
            ã¨æŠ¼ã—ã¦ã„ãã¨ã€æ¥åœ°æ™‚é–“ãƒ»æ»ç©ºæ™‚é–“ãƒ»1æ­©ã®åˆè¨ˆæ™‚é–“ãŒä¸‹ã«è¡¨ç¤ºã•ã‚Œã¾ã™ã€‚
            ï¼ˆå¥‡æ•°å› = æ¥åœ°, å¶æ•°å› = é›¢åœ°ï¼‰
          </p>
          <button
            className="ghost-button"
            onClick={handleClearMarkers}
            disabled={!contactFrames.length}
          >
            ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚¯ãƒªã‚¢
          </button>

          <div className="step-table-wrapper">
            <table className="step-table">
              <thead>
                <tr>
                  <th>ã‚¹ãƒ†ãƒƒãƒ—</th>
                  <th>æ¥åœ°ãƒ•ãƒ¬ãƒ¼ãƒ </th>
                  <th>é›¢åœ°ãƒ•ãƒ¬ãƒ¼ãƒ </th>
                  <th>æ¬¡ã®æ¥åœ°</th>
                  <th>æ¥åœ°æ™‚é–“ [s]</th>
                  <th>æ»ç©ºæ™‚é–“ [s]</th>
                  <th>1æ­©åˆè¨ˆ [s]</th>
                  <th>ãƒ”ãƒƒãƒ [æ­©/s]</th>
                </tr>
              </thead>
              <tbody>
                {stepMetrics.map((s) => (
                  <tr key={s.index}>
                    <td>{s.index}</td>
                    <td>{s.contactFrame}</td>
                    <td>{s.toeOffFrame}</td>
                    <td>{s.nextContactFrame ?? "ãƒ¼"}</td>
                    <td>
                      {s.contactTime != null
                        ? s.contactTime.toFixed(3)
                        : "ãƒ¼"}
                    </td>
                    <td>
                      {s.flightTime != null ? s.flightTime.toFixed(3) : "ãƒ¼"}
                    </td>
                    <td>
                      {s.stepTime != null ? s.stepTime.toFixed(3) : "ãƒ¼"}
                    </td>
                    <td>
                      {s.stepPitch != null ? s.stepPitch.toFixed(2) : "ãƒ¼"}
                    </td>
                  </tr>
                ))}
                {!stepMetrics.length && (
                  <tr>
                    <td colSpan={8}>ã¾ã ãƒãƒ¼ã‚«ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</td>
                  </tr>
                )}
              </tbody>
            </table>
          </div>

          <div className="step-summary">
            <h4>å¹³å‡å€¤</h4>
            <p>ã‚¹ãƒ†ãƒƒãƒ—æ•°: {stepSummary.stepCount}</p>
            <p>
              å¹³å‡æ¥åœ°æ™‚é–“:{" "}
              {stepSummary.avgContact != null
                ? `${stepSummary.avgContact.toFixed(3)} s`
                : "ãƒ¼"}
            </p>
            <p>
              å¹³å‡æ»ç©ºæ™‚é–“:{" "}
              {stepSummary.avgFlight != null
                ? `${stepSummary.avgFlight.toFixed(3)} s`
                : "ãƒ¼"}
            </p>
            <p>
              å¹³å‡1æ­©æ™‚é–“:{" "}
              {stepSummary.avgStepTime != null
                ? `${stepSummary.avgStepTime.toFixed(3)} s`
                : "ãƒ¼"}
            </p>
            <p>
              å¹³å‡ãƒ”ãƒƒãƒ:{" "}
              {stepSummary.avgStepPitch != null
                ? `${stepSummary.avgStepPitch.toFixed(2)} æ­©/s`
                : "ãƒ¼"}
            </p>
            <p>
              å¹³å‡ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ï¼ˆåŒºé–“è·é›¢ Ã· æ­©æ•°ï¼‰:{" "}
              {stepSummary.avgStride != null
                ? `${stepSummary.avgStride.toFixed(2)} m`
                : "ãƒ¼"}
            </p>
          </div>

          <hr />

          <h3>Supabase æ¥ç¶š ï¼† ä¿å­˜</h3>
          <div className="supabase-section">
            <p>
              ã€Œrunning_analysis_sessionsã€ãƒ†ãƒ¼ãƒ–ãƒ«ã‹ã‚‰æœ€æ–° 5
              ä»¶ã ã‘ SELECT ã—ã¦ã€æ¥ç¶šã§ãã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ã€‚
            </p>
            <button className="primary-button" onClick={handleSupabaseTest}>
              Supabase ã«æ¥ç¶šãƒ†ã‚¹ãƒˆ
            </button>
            {supabaseTestResult && (
              <p className="supabase-message">{supabaseTestResult}</p>
            )}
          </div>

          <div className="supabase-section">
            <h4>è§£æã‚»ãƒƒã‚·ãƒ§ãƒ³ä¿å­˜</h4>
            <p>
              ç¾åœ¨é¸æŠä¸­ã®å‹•ç”»ãƒ•ã‚¡ã‚¤ãƒ«åãƒ»åŒºé–“ãƒ•ãƒ¬ãƒ¼ãƒ æ•°ãƒ»è·é›¢ãƒ»å¹³å‡é€Ÿåº¦ãªã©ã‚’ä½¿ã£ã¦ã€
              running_analysis_sessions
              ã«1ä»¶ãƒ¬ã‚³ãƒ¼ãƒ‰ã‚’ä¿å­˜ã—ã¾ã™ï¼ˆå‰åŠï¼å¾ŒåŠã‚’åˆ†ã‘ã¦ä¿å­˜ã—ãŸã„å ´åˆã¯ã€
              åŒºé–“ã‚’å¤‰æ›´ã—ã¦ãƒ©ãƒ™ãƒ«ã‚’ã€Œå‰åŠã€ã€Œå¾ŒåŠã€ã«ã—ã¦2å›ä¿å­˜ã—ã¦ãã ã•ã„ï¼‰ã€‚
            </p>
            <label className="field-row">
              <span>ãƒ©ãƒ™ãƒ«</span>
              <input
                type="text"
                value={labelInput}
                onChange={(e) => setLabelInput(e.target.value)}
                placeholder="ä¾‹ï¼‰å‰åŠ5mãƒ»å¾ŒåŠ5m ãªã©"
              />
            </label>
            <button
              className="primary-button"
              onClick={handleSaveSession}
              disabled={saving}
            >
              è§£æã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’ä¿å­˜
            </button>
            {saveResult && <p className="supabase-message">{saveResult}</p>}
          </div>

          <div className="supabase-section">
            <h4>æœ€è¿‘ä¿å­˜ã—ãŸã‚»ãƒƒã‚·ãƒ§ãƒ³ï¼ˆæœ€æ–°5ä»¶ï¼‰</h4>
            <button
              className="ghost-button"
              onClick={fetchLatestSessions}
              disabled={loadingLatest}
            >
              æœ€æ–°5ä»¶ã‚’å†èª­ã¿è¾¼ã¿
            </button>
            {latestSessions.length === 0 ? (
              <p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            ) : (
              <ul className="session-list">
                {latestSessions.map((s) => (
                  <li
                    key={s.id}
                    className={
                      latestDetail && latestDetail.id === s.id ? "active" : ""
                    }
                    onClick={() => setLatestDetail(s)}
                  >
                    {s.source_video_name ?? "(åç§°ãªã—)"} ï¼{" "}
                    {new Date(s.created_at).toLocaleString()} ï¼ è·é›¢:{" "}
                    {s.distance_m ?? "ãƒ¼"} m ï¼ é€Ÿåº¦:{" "}
                    {s.avg_speed_mps != null
                      ? s.avg_speed_mps.toFixed(3)
                      : "ãƒ¼"}{" "}
                    m/s
                  </li>
                ))}
              </ul>
            )}

            <h4>æœ€æ–°1ä»¶ã®è©³ç´°</h4>
            {latestDetail ? (
              <div className="latest-detail">
                <p>ID: {latestDetail.id}</p>
                <p>
                  å‹•ç”»: {latestDetail.source_video_name ?? "(åç§°ãªã—)"} / è·é›¢:{" "}
                  {latestDetail.distance_m ?? "ãƒ¼"} m / ãƒ•ãƒ¬ãƒ¼ãƒ æ•°:{" "}
                  {latestDetail.frames_count ?? "ãƒ¼"}
                </p>
                <p>
                  åŒºé–“:{" "}
                  {latestDetail.section_start_frame != null
                    ? latestDetail.section_start_frame
                    : "ãƒ¼"}
                  ã€œ
                  {latestDetail.section_end_frame != null
                    ? latestDetail.section_end_frame
                    : "ãƒ¼"}{" "}
                  ï¼ˆ
                  {latestDetail.section_frame_count != null
                    ? latestDetail.section_frame_count
                    : "ãƒ¼"}{" "}
                  ãƒ•ãƒ¬ãƒ¼ãƒ ï¼‰
                </p>
                <p>
                  åŒºé–“æ™‚é–“:{" "}
                  {latestDetail.section_time_s != null
                    ? `${latestDetail.section_time_s.toFixed(3)} s`
                    : "ãƒ¼"}{" "}
                  ï¼ å¹³å‡é€Ÿåº¦:{" "}
                  {latestDetail.avg_speed_mps != null
                    ? `${latestDetail.avg_speed_mps.toFixed(3)} m/s`
                    : "ãƒ¼"}
                </p>
                <p>ä½¿ç”¨ fps: {latestDetail.target_fps ?? "ãƒ¼"}</p>
                <p>ãƒ©ãƒ™ãƒ«: {latestDetail.label ?? "ãƒ¼"}</p>
                <p>ãƒ¡ãƒ¢: {latestDetail.notes ?? "ãƒ¼"}</p>
              </div>
            ) : (
              <p>ã¾ã ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</p>
            )}
          </div>
        </section>
      </main>

      {/* æŠ½å‡ºç”¨ã®éš ã— video */}
      <video
        ref={videoRef}
        style={{ display: "none" }}
        playsInline
        muted
        preload="auto"
      />
    </div>
  );
};

export default App;
