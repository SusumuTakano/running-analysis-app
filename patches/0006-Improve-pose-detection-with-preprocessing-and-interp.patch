From da222809e73aa183d5626f5504a03017d532960c Mon Sep 17 00:00:00 2001
From: SusumuTakano <genspark_dev@genspark.ai>
Date: Sun, 7 Dec 2025 06:42:49 +0000
Subject: [PATCH 06/26] Improve pose detection with preprocessing and
 interpolation

- Added image preprocessing (contrast and brightness adjustment)
- Enhanced visibility of person in frames before pose detection
- Extended interpolation range from 20 to 50 frames
- Apply preprocessing to make person more detectable
- Should improve detection at start position
- More aggressive interpolation for missing frames
---
 src/App.tsx | 29 ++++++++++++++++++++++++-----
 1 file changed, 24 insertions(+), 5 deletions(-)

diff --git a/src/App.tsx b/src/App.tsx
index b6f2b53..2668ac5 100644
--- a/src/App.tsx
+++ b/src/App.tsx
@@ -2395,14 +2395,14 @@ const [notesInput, setNotesInput] = useState<string>("");
         let prevIndex = i - 1;
         let nextIndex = i + 1;
         
-        // ğŸ”¥ å‰ã®æœ‰åŠ¹ãªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ¢ã™ï¼ˆæœ€å¤§20ãƒ•ãƒ¬ãƒ¼ãƒ å‰ã¾ã§ï¼šãƒãƒ©ãƒ³ã‚¹èª¿æ•´ï¼‰
-        while (prevIndex >= 0 && prevIndex >= i - 20) {
+        // ğŸ”¥ å‰ã®æœ‰åŠ¹ãªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ¢ã™ï¼ˆæœ€å¤§50ãƒ•ãƒ¬ãƒ¼ãƒ å‰ã¾ã§ï¼šã‚ˆã‚Šåºƒç¯„å›²ï¼‰
+        while (prevIndex >= 0 && prevIndex >= i - 50) {
           if (interpolated[prevIndex]?.landmarks) break;
           prevIndex--;
         }
         
-        // ğŸ”¥ æ¬¡ã®æœ‰åŠ¹ãªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ¢ã™ï¼ˆæœ€å¤§20ãƒ•ãƒ¬ãƒ¼ãƒ å¾Œã¾ã§ï¼šãƒãƒ©ãƒ³ã‚¹èª¿æ•´ï¼‰
-        while (nextIndex < interpolated.length && nextIndex <= i + 20) {
+        // ğŸ”¥ æ¬¡ã®æœ‰åŠ¹ãªãƒ•ãƒ¬ãƒ¼ãƒ ã‚’æ¢ã™ï¼ˆæœ€å¤§50ãƒ•ãƒ¬ãƒ¼ãƒ å¾Œã¾ã§ï¼šã‚ˆã‚Šåºƒç¯„å›²ï¼‰
+        while (nextIndex < interpolated.length && nextIndex <= i + 50) {
           if (interpolated[nextIndex]?.landmarks) break;
           nextIndex++;
         }
@@ -2606,6 +2606,23 @@ const [notesInput, setNotesInput] = useState<string>("");
       if (!tempCtx) {
         throw new Error("Canvas context ã®ä½œæˆã«å¤±æ•—ã—ã¾ã—ãŸ");
       }
+      
+      // ç”»åƒå‰å‡¦ç†é–¢æ•°ï¼šã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã¨æ˜åº¦ã‚’èª¿æ•´
+      const preprocessImage = (imageData: ImageData): ImageData => {
+        const data = imageData.data;
+        const contrast = 1.3; // ã‚³ãƒ³ãƒˆãƒ©ã‚¹ãƒˆã‚’ä¸Šã’ã‚‹
+        const brightness = 10; // æ˜åº¦ã‚’å°‘ã—ä¸Šã’ã‚‹
+        
+        for (let i = 0; i < data.length; i += 4) {
+          // RGBå€¤ã‚’èª¿æ•´
+          data[i] = Math.min(255, Math.max(0, (data[i] - 128) * contrast + 128 + brightness));     // R
+          data[i + 1] = Math.min(255, Math.max(0, (data[i + 1] - 128) * contrast + 128 + brightness)); // G
+          data[i + 2] = Math.min(255, Math.max(0, (data[i + 2] - 128) * contrast + 128 + brightness)); // B
+          // Alpha channel (i + 3) ã¯å¤‰æ›´ã—ãªã„
+        }
+        
+        return imageData;
+      };
 
       // MediaPipeå…¥åŠ›ç”¨ã«ç¸®å°ã—ãŸã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ç”¨æ„
       const maxPoseWidth = isIPad ? 540 : 960;
@@ -2684,7 +2701,9 @@ const [notesInput, setNotesInput] = useState<string>("");
         const frame = framesRef.current[i];
 
         // ğŸ”§ canvasã‚’å†åˆ©ç”¨ï¼ˆæ¯å›ä½œæˆã—ãªã„ï¼‰
-        tempCtx.putImageData(frame, 0, 0);
+        // å‰å‡¦ç†ã‚’é©ç”¨ã—ã¦äººç‰©ã‚’æ¤œå‡ºã—ã‚„ã™ãã™ã‚‹
+        const processedFrame = preprocessImage(frame);
+        tempCtx.putImageData(processedFrame, 0, 0);
         
 
         try {
-- 
2.39.5

