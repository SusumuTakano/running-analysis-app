From 4d0899ba1f1e18ce7e84a686d4102ee76a46491d Mon Sep 17 00:00:00 2001
From: SusumuTakano <genspark_dev@genspark.ai>
Date: Sat, 20 Dec 2025 13:14:48 +0000
Subject: [PATCH 15/26] fix: Use actual video resolution for pixel coordinates
 in stride calculation

CRITICAL BUG FIX:
- Multi-camera stride was incorrect (1.28m) vs single-camera (1.61m)
- Root cause: pixel coordinate calculation used hardcoded 1920x1080
- Calibration used actual video resolution (e.g. 1280x720 or other)
- This mismatch caused incorrect Homography transformation results

SOLUTION:
- Extract actualVideoWidth/Height from videoRef.current.videoWidth/Height
- Use same resolution for both calibration and stride calculation
- This ensures pixel coordinates match Homography matrix expectations

EXPECTED RESULT:
- Multi-camera stride should now match single-camera (~1.5-1.6m)
- World coordinates accurately represent runner position
- No more discrepancy between analysis modes
---
 src/App.tsx | 13 +++++++++----
 1 file changed, 9 insertions(+), 4 deletions(-)

diff --git a/src/App.tsx b/src/App.tsx
index 679f4b6..ed0f376 100644
--- a/src/App.tsx
+++ b/src/App.tsx
@@ -2064,6 +2064,10 @@ const clearMarksByButton = () => {
       }
     };
     
+    // ğŸ¯ ãƒ“ãƒ‡ã‚ªã®å®Ÿéš›ã®è§£åƒåº¦ã‚’å–å¾—ï¼ˆã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨ä¸€è‡´ã•ã›ã‚‹ï¼‰
+    const actualVideoWidth = videoRef.current?.videoWidth || 1920;
+    const actualVideoHeight = videoRef.current?.videoHeight || 1080;
+    
     // æ¥åœ°æ™‚ã®è¶³ã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã‚’å–å¾—ï¼ˆå·¦å³ã®è¶³é¦–ãƒ»ã¤ã¾å…ˆã‹ã‚‰åˆ¤å®šï¼‰
     const getContactFootPixel = (frame: number): { x: number; y: number } | null => {
       if (!poseResults[frame]?.landmarks) return null;
@@ -2091,13 +2095,14 @@ const clearMarksByButton = () => {
         footY = rightY;
       }
       
-      // æ­£è¦åŒ–åº§æ¨™(0-1)ã‚’ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã«å¤‰æ›
-      const pixelX = footX * (videoWidth || 1920);
-      const pixelY = footY * (videoHeight || 1080);
+      // ğŸ¯ CRITICAL FIX: ã‚­ãƒ£ãƒªãƒ–ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ã¨åŒã˜è§£åƒåº¦ã‚’ä½¿ç”¨
+      // æ­£è¦åŒ–åº§æ¨™(0-1)ã‚’ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ã«å¤‰æ›ï¼ˆvideoRef.currentã‹ã‚‰å–å¾—ï¼‰
+      const pixelX = footX * actualVideoWidth;
+      const pixelY = footY * actualVideoHeight;
       
       // ğŸ” ãƒ‡ãƒãƒƒã‚°: åˆå›ã®ã¿ãƒ“ãƒ‡ã‚ªã‚µã‚¤ã‚ºã¨ã‚µãƒ³ãƒ—ãƒ«åº§æ¨™ã‚’å‡ºåŠ›
       if (frame === (contactFrames[0] || 0)) {
-        console.log(`ğŸ” [DEBUG] Video dimensions for pixel conversion: ${videoWidth}x${videoHeight}`);
+        console.log(`ğŸ” [DEBUG] Video dimensions for pixel conversion: ${actualVideoWidth}x${actualVideoHeight} (from videoRef.current)`);
         console.log(`ğŸ” [DEBUG] Sample: normalized(${footX.toFixed(3)}, ${footY.toFixed(3)}) â†’ pixel(${pixelX.toFixed(0)}, ${pixelY.toFixed(0)})`);
       }
       
-- 
2.39.5

