From 0a06c4f15a2c9aa3a4135a25afb473c72446f9ee Mon Sep 17 00:00:00 2001
From: SusumuTakano <genspark_dev@genspark.ai>
Date: Sat, 20 Dec 2025 13:36:29 +0000
Subject: [PATCH 18/26] fix: Implement ChatGPT recommended TrueStride
 calculation method
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

CRITICAL FIX based on ChatGPT analysis:

PROBLEM (root cause identified):
- Current: Calculate stride per-segment, then merge â†’ boundary breaks
- Result: Stride anomalies at boundaries (2.21m, 1.83m)
- User needs: "Startâ†’each step stride progression" time-series view
- Average is meaningless, need per-step progression (0-15m)

CHATGPT SOLUTION (Modification A):
- Collect contact events from all segments
- Convert to globalDist (0-15m unified coords) via Homography
- Sort by globalDist (time-series order)
- Clean duplicates/gaps
- FINALLY calculate: TrueStride[i] = globalDist[i+1] - globalDist[i]

IMPLEMENTATION:
1. Filter real steps (exclude interpolated)
2. Sort by globalDist (time-series)
3. Calculate TrueStride as consecutive difference
4. Flag anomalies (< 0.6m or > 2.2m)
5. Detailed logging for each step with ChatGPT requested format

EXPECTED RESULT:
- Accurate "stride progression" from start (0m) to finish (15m)
- No boundary anomalies
- Matches single-camera stride values
- Clear visualization of stride expansion/contraction

Modified: src/App.tsx
---
 src/App.tsx | 109 ++++++++++++++++++++++++++--------------------------
 1 file changed, 55 insertions(+), 54 deletions(-)

diff --git a/src/App.tsx b/src/App.tsx
index 2f20c04..d8cbb04 100644
--- a/src/App.tsx
+++ b/src/App.tsx
@@ -6816,66 +6816,67 @@ const handleNewMultiCameraStart = (run: Run, segments: RunSegment[]) => {
       }
     }
     
-    // ğŸ¯ ã‚°ãƒ­ãƒ¼ãƒãƒ«è·é›¢ã‹ã‚‰ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚’å†è¨ˆç®—ï¼ˆChatGPTææ¡ˆï¼‰
-    // ãŸã ã—ã€è£œé–“ã‚¹ãƒ†ãƒƒãƒ—ã¯é™¤å¤–ï¼ˆè£œé–“ã‚¹ãƒ†ãƒƒãƒ—ã¯å®Ÿæ¸¬å€¤ã§ã¯ãªã„ãŸã‚ï¼‰
-    console.log("ğŸ”§ Recalculating strides from globalDistance (excluding interpolated steps)...");
-    console.log("\nğŸ“‹ === ChatGPT Requested Log: Detailed Step Analysis ===");
-    
-    for (let i = 0; i < finalSteps.length; i++) {
-      const currentDist = finalSteps[i].distanceAtContact || 0;
-      const nextDist = finalSteps[i + 1]?.distanceAtContact;
-      
-      // ğŸ¯ ChatGPTãŒè¦æ±‚ã™ã‚‹è©³ç´°ãƒ­ã‚°
-      console.log(`\n[Step ${i}]`);
+    // ğŸ¯ ChatGPTæ¨å¥¨: TrueStrideã‚’ãƒãƒ¼ã‚¸å¾Œã«å†è¨ˆç®—ï¼ˆæ­£ã—ã„å®Ÿè£…ï¼‰
+    // ============================================================
+    // ä¿®æ­£A: ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã¯ã€Œãƒãƒ¼ã‚¸å¾Œã€ã«å¿…ãšå†è¨ˆç®—ã™ã‚‹
+    // - ã‚»ã‚°ãƒ¡ãƒ³ãƒˆå†…è¨ˆç®—ã¯æ¨ã¦ã‚‹
+    // - å…¨æ¥åœ°ã‚’globalDistã§ã‚½ãƒ¼ãƒˆå¾Œã€é€£ç¶šã™ã‚‹å·®åˆ†ãŒTrueStride
+    // ============================================================
+    console.log("\nğŸ”§ === Recalculating TrueStride from globalDistance (ChatGPT method) ===");
+    
+    // å®Ÿæ¸¬ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆè£œé–“ã¯é™¤å¤–ï¼‰
+    const realStepsForStride = finalSteps.filter(s => !s.isInterpolated && Number.isFinite(s.distanceAtContact));
+    
+    // globalDistã§ã‚½ãƒ¼ãƒˆï¼ˆæ™‚ç³»åˆ—é †ï¼‰
+    realStepsForStride.sort((a, b) => (a.distanceAtContact || 0) - (b.distanceAtContact || 0));
+    
+    console.log(`\nğŸ“Š Real steps (excluding interpolated): ${realStepsForStride.length}`);
+    console.log(`ğŸ“‹ Calculating TrueStride[i] = globalDist[i+1] - globalDist[i]\n`);
+    
+    // TrueStrideã‚’è¨ˆç®—ï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ã§æ¬¡ã®æ¥åœ°ã¾ã§ã®è·é›¢ï¼‰
+    for (let i = 0; i < realStepsForStride.length; i++) {
+      const currentDist = realStepsForStride[i].distanceAtContact || 0;
+      const nextStep = realStepsForStride[i + 1];
+      const nextDist = nextStep?.distanceAtContact;
+      
+      // ğŸ¯ ChatGPTè©³ç´°ãƒ­ã‚°
+      console.log(`[Step ${i}] contactFrame=${realStepsForStride[i].contactFrame}, segmentId=${realStepsForStride[i].segmentId ?? 'N/A'}`);
       console.log(`  contact_globalDist: ${currentDist.toFixed(3)}m`);
+      
       if (nextDist != null) {
+        const trueStride = nextDist - currentDist;
         console.log(`  next_contact_globalDist: ${nextDist.toFixed(3)}m`);
-        console.log(`  TrueStride (next - current): ${(nextDist - currentDist).toFixed(3)}m`);
-      }
-      console.log(`  isInterpolated: ${finalSteps[i].isInterpolated === true}`);
-      console.log(`  segmentId: ${finalSteps[i].segmentId ?? 'N/A'}`);
-      console.log(`  contactFrame: ${finalSteps[i].contactFrame}`);
-      console.log(`  current stride value: ${finalSteps[i].stride?.toFixed(3) ?? 'N/A'}m`);
-      
-      if (i === 0) {
-        // æœ€åˆã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ãã®ã¾ã¾
-        console.log(`  â†’ Action: Initial step, kept as-is`);
-        continue;
-      }
-      
-      // ğŸš« è£œé–“ã‚¹ãƒ†ãƒƒãƒ—ã¨ã€è£œé–“ã‚¹ãƒ†ãƒƒãƒ—ã®ç›´å¾Œã®ã‚¹ãƒ†ãƒƒãƒ—ã¯ã‚¹ã‚­ãƒƒãƒ—
-      const isCurrentInterpolated = finalSteps[i].isInterpolated === true;
-      const isPrevInterpolated = finalSteps[i - 1].isInterpolated === true;
-      
-      if (isCurrentInterpolated) {
-        console.log(`  â†’ Action: Interpolated step, kept as-is`);
-        continue;
-      }
-      
-      if (isPrevInterpolated) {
-        console.log(`  â†’ Action: After interpolated, kept as Homography value`);
-        continue;
-      }
-      
-      // å®Ÿæ¸¬ã‚¹ãƒ†ãƒƒãƒ—é–“ã®ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã®ã¿å†è¨ˆç®—
-      const prevDist = finalSteps[i - 1].distanceAtContact || 0;
-      const recalculatedStride = currentDist - prevDist;
-      
-      console.log(`  prev_contact_globalDist: ${prevDist.toFixed(3)}m`);
-      console.log(`  Recalculated stride (current - prev): ${recalculatedStride.toFixed(3)}m`);
-      
-      // ç•°å¸¸å€¤ãƒã‚§ãƒƒã‚¯ï¼ˆ0.5mæœªæº€ã€3.0mè¶…ã¯è­¦å‘Šï¼‰
-      if (recalculatedStride < 0.5 || recalculatedStride > 3.0) {
-        console.warn(`  âš ï¸ WARNING: Unusual stride ${recalculatedStride.toFixed(3)}m`);
+        console.log(`  TrueStride (difference): ${trueStride.toFixed(3)}m`);
+        
+        // ç•°å¸¸å€¤ãƒ•ãƒ©ã‚°ï¼ˆ0.6mæœªæº€ã€2.2mè¶…ï¼‰
+        if (trueStride < 0.6 || trueStride > 2.2) {
+          console.warn(`  âš ï¸ strideAnomaly: true (unusual stride)`);
+          realStepsForStride[i].quality = 'warning'; // UIã§èµ¤ãè¡¨ç¤º
+        }
+        
+        // ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚’æ›´æ–°
+        realStepsForStride[i].stride = trueStride;
+        realStepsForStride[i].fullStride = trueStride;
+        
+        console.log(`  â†’ UPDATED stride to ${trueStride.toFixed(3)}m`);
+      } else {
+        console.log(`  â†’ Last step, no next contact`);
+        realStepsForStride[i].stride = null;
+        realStepsForStride[i].fullStride = undefined;
       }
-      
-      console.log(`  â†’ Action: UPDATE stride from ${finalSteps[i].stride?.toFixed(3) ?? 'N/A'}m to ${recalculatedStride.toFixed(3)}m`);
-      
-      finalSteps[i].stride = recalculatedStride;
-      finalSteps[i].fullStride = recalculatedStride;
     }
     
-    console.log("\n=== End of Detailed Step Analysis ===\n");
+    console.log("\nâœ… TrueStride recalculation complete (ChatGPT method)\n");
+    
+    // è£œé–“ã‚¹ãƒ†ãƒƒãƒ—ã¯ãã®ã¾ã¾ä¿æŒï¼ˆè¡¨ç¤ºç”¨ï¼‰
+    const interpolatedSteps = finalSteps.filter(s => s.isInterpolated === true);
+    
+    // æœ€çµ‚çš„ãªã‚¹ãƒ†ãƒƒãƒ—ãƒªã‚¹ãƒˆã‚’å†æ§‹ç¯‰ï¼ˆrealStepsForStride + interpolatedStepsï¼‰
+    finalSteps.length = 0;
+    finalSteps.push(...realStepsForStride, ...interpolatedSteps);
+    
+    // globalDistã§å†ã‚½ãƒ¼ãƒˆï¼ˆæ™‚ç³»åˆ—é †ã«æˆ»ã™ï¼‰
+    finalSteps.sort((a, b) => (a.distanceAtContact || 0) - (b.distanceAtContact || 0));
     
     // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†å‰²ã‚Šå½“ã¦
     finalSteps.forEach((step, idx) => {
-- 
2.39.5

