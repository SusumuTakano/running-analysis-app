From 71d01c15717d8fa2e7690573960ac41a8a64d21d Mon Sep 17 00:00:00 2001
From: SusumuTakano <genspark_dev@genspark.ai>
Date: Sat, 20 Dec 2025 14:10:39 +0000
Subject: [PATCH 21/26] =?UTF-8?q?Revert=20"=F0=9F=94=A7=20CRITICAL=20FIX:?=
 =?UTF-8?q?=20Apply=20proportional=20scaling=20to=20Homography=20(match=20?=
 =?UTF-8?q?single-camera)"?=
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

This reverts commit b5554b36cfbc82255877b22dcb571593c3520486.
---
 src/App.tsx | 87 +++++++++++++++++------------------------------------
 1 file changed, 27 insertions(+), 60 deletions(-)

diff --git a/src/App.tsx b/src/App.tsx
index 7f75c9b..36f789d 100644
--- a/src/App.tsx
+++ b/src/App.tsx
@@ -6659,30 +6659,6 @@ const handleNewMultiCameraStart = (run: Run, segments: RunSegment[]) => {
         }
       };
       
-      // ğŸ¯ CRITICAL FIX: æ¯”ä¾‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚«ãƒ¡ãƒ©ã®æ‰‹æ³•ã‚’é©ç”¨ï¼‰
-      // ãƒ›ãƒ¢ã‚°ãƒ©ãƒ•ã‚£ã®å®Ÿæ¸¬ç¯„å›²ã‚’ã€æœŸå¾…ã•ã‚Œã‚‹5måŒºé–“ã«æ¯”ä¾‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã™ã‚‹
-      const worldPositions: Array<{ worldY: number; localIdx: number }> = [];
-      
-      segmentSteps.forEach((step, localIdx) => {
-        if (step.contactPixelX != null && step.contactPixelY != null) {
-          const worldPos = applyHomographyLocal(step.contactPixelX, step.contactPixelY);
-          if (worldPos) {
-            worldPositions.push({ worldY: worldPos.y, localIdx });
-          }
-        }
-      });
-      
-      // å®Ÿæ¸¬ç¯„å›²ã®æœ€å°ãƒ»æœ€å¤§ã‚’å–å¾—
-      const worldYValues = worldPositions.map(p => p.worldY);
-      const minWorldY = Math.min(...worldYValues);
-      const maxWorldY = Math.max(...worldYValues);
-      const actualCoverage = maxWorldY - minWorldY; // å®Ÿéš›ã«ã‚«ãƒãƒ¼ã—ãŸè·é›¢ï¼ˆä¾‹: 3.85mï¼‰
-      const expectedCoverage = segment.endDistanceM - segment.startDistanceM; // æœŸå¾…ã•ã‚Œã‚‹è·é›¢ï¼ˆä¾‹: 5.0mï¼‰
-      
-      const scalingFactor = actualCoverage > 0.1 ? expectedCoverage / actualCoverage : 1.0;
-      
-      console.log(`  ğŸ“ Segment ${segIdx + 1} Scaling: actualRange=${minWorldY.toFixed(2)}-${maxWorldY.toFixed(2)}m (${actualCoverage.toFixed(2)}m), expected=${expectedCoverage.toFixed(2)}m, scaleFactor=${scalingFactor.toFixed(4)}`);
-      
       segmentSteps.forEach((step, localIdx) => {
         let localDistance = step.distanceAtContact || 0;
         let recalculatedStride = step.stride;
@@ -6692,28 +6668,24 @@ const handleNewMultiCameraStart = (run: Run, segments: RunSegment[]) => {
           const worldPos = applyHomographyLocal(step.contactPixelX, step.contactPixelY);
           
           if (worldPos) {
-            // âœ… æ¯”ä¾‹ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ã‚’é©ç”¨ï¼ˆã‚·ãƒ³ã‚°ãƒ«ã‚«ãƒ¡ãƒ©ã¨åŒã˜è€ƒãˆæ–¹ï¼‰
-            // å®Ÿæ¸¬ç¯„å›²ï¼ˆminWorldYã€œmaxWorldYï¼‰ã‚’æœŸå¾…ç¯„å›²ï¼ˆ0ã€œ5mï¼‰ã«ãƒãƒƒãƒ”ãƒ³ã‚°
-            const normalizedPosition = (worldPos.y - minWorldY) / actualCoverage; // 0.0ã€œ1.0
-            localDistance = normalizedPosition * expectedCoverage; // 0mã€œ5m
+            // å®Ÿä¸–ç•Œåº§æ¨™ã®Yæˆåˆ†ã‚’è·é›¢ã¨ã—ã¦ä½¿ç”¨ï¼ˆèµ°è¡Œæ–¹å‘ï¼yè»¸ï¼‰
+            // Xæˆåˆ†ã¯ãƒ¬ãƒ¼ãƒ³å¹…æ–¹å‘ï¼ˆ0ã€œ1.22mï¼‰ã€Yæˆåˆ†ã¯èµ°è¡Œæ–¹å‘ï¼ˆ0ã€œ15mï¼‰
+            localDistance = Math.abs(worldPos.y - segment.startDistanceM);
             
-            console.log(`  ğŸ¯ Step ${localIdx}: Pixel(${step.contactPixelX.toFixed(0)}, ${step.contactPixelY.toFixed(0)}) â†’ World(${worldPos.x.toFixed(2)}, ${worldPos.y.toFixed(2)})m â†’ Scaled: ${localDistance.toFixed(2)}m (factor=${scalingFactor.toFixed(3)})`);
+            console.log(`  ğŸ¯ Step ${localIdx}: Pixel(${step.contactPixelX.toFixed(0)}, ${step.contactPixelY.toFixed(0)}) â†’ World(${worldPos.x.toFixed(2)}, ${worldPos.y.toFixed(2)})m (x=lane, y=distance) â†’ localDistance=${localDistance.toFixed(2)}m`);
             
-            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ãŒã‚ã‚Œã°ã€ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚‚å†è¨ˆç®—ï¼ˆã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é©ç”¨å¾Œï¼‰
+            // æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã®ãƒ”ã‚¯ã‚»ãƒ«åº§æ¨™ãŒã‚ã‚Œã°ã€ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚‚å†è¨ˆç®—
             const nextStep = segmentSteps[localIdx + 1];
             if (nextStep?.contactPixelX != null && nextStep?.contactPixelY != null) {
               const nextWorldPos = applyHomographyLocal(nextStep.contactPixelX, nextStep.contactPixelY);
               if (nextWorldPos) {
-                // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é©ç”¨å¾Œã®æ¬¡ã®ä½ç½®
-                const nextNormalizedPosition = (nextWorldPos.y - minWorldY) / actualCoverage;
-                const nextLocalDistance = nextNormalizedPosition * expectedCoverage;
-                
-                // ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°æ¸ˆã¿ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰è¨ˆç®—
-                const scaledDy = nextLocalDistance - localDistance;
-                const dx = nextWorldPos.x - worldPos.x; // ãƒ¬ãƒ¼ãƒ³å¹…æ–¹å‘ã¯ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°ä¸è¦
-                recalculatedStride = Math.sqrt(dx * dx + scaledDy * scaledDy);
+                // å®Ÿä¸–ç•Œåº§æ¨™ã§ã®ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚’è¨ˆç®—ï¼ˆãƒ¦ãƒ¼ã‚¯ãƒªãƒƒãƒ‰è·é›¢ï¼‰
+                // dx = ãƒ¬ãƒ¼ãƒ³å¹…æ–¹å‘ã®ç§»å‹•, dy = èµ°è¡Œæ–¹å‘ã®ç§»å‹•
+                const dx = nextWorldPos.x - worldPos.x;
+                const dy = nextWorldPos.y - worldPos.y;
+                recalculatedStride = Math.sqrt(dx * dx + dy * dy);
                 
-                console.log(`    âœ… Scaled stride: ${recalculatedStride.toFixed(2)}m (dy_scaled=${scaledDy.toFixed(2)}, dx=${dx.toFixed(2)}) (was ${step.stride?.toFixed(2) ?? 'N/A'}m)`);
+                console.log(`    âœ… Recalculated stride using Homography: ${recalculatedStride.toFixed(2)}m (dx=${dx.toFixed(2)}, dy=${dy.toFixed(2)}) (was ${step.stride?.toFixed(2) ?? 'N/A'}m)`);
               }
             }
           } else {
@@ -6729,8 +6701,8 @@ const handleNewMultiCameraStart = (run: Run, segments: RunSegment[]) => {
         
         mergedSteps.push({
           ...step,
-          stride: recalculatedStride, // TrueStride: ã‚¹ã‚±ãƒ¼ãƒªãƒ³ã‚°é©ç”¨å¾Œ
-          fullStride: recalculatedStride ?? undefined,
+          stride: recalculatedStride, // TrueStride: Homographyã§å†è¨ˆç®—ã•ã‚ŒãŸã‚¹ãƒˆãƒ©ã‚¤ãƒ‰
+          fullStride: recalculatedStride ?? undefined, // UIã§è¡¨ç¤ºã•ã‚Œã‚‹fullStrideã‚‚æ›´æ–°
           distanceAtContact: globalDistance,
           index: globalStepIndex++,
           segmentId: segment.id,
@@ -6852,25 +6824,23 @@ const handleNewMultiCameraStart = (run: Run, segments: RunSegment[]) => {
     // ============================================================
     console.log("\nğŸ”§ === Recalculating TrueStride from globalDistance (ChatGPT method) ===");
     
-    // ğŸ†• é‡è¦ãªå¤‰æ›´: è£œé–“ã‚¹ãƒ†ãƒƒãƒ—ã‚‚å«ã‚ã¦è¨ˆç®—ï¼ˆãƒãƒ¼ã‚¯æ•°ãŒå°‘ãªã„å ´åˆã®å¯¾å¿œï¼‰
-    // è£œé–“ã‚¹ãƒ†ãƒƒãƒ—ã¯æ¨å®šå€¤ã ãŒã€ã‚®ãƒ£ãƒƒãƒ—ã‚’åŸ‹ã‚ã¦ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰è¨ˆç®—ã‚’æ­£ç¢ºã«ã™ã‚‹
-    const allStepsForStride = finalSteps.filter(s => Number.isFinite(s.distanceAtContact));
+    // å®Ÿæ¸¬ã‚¹ãƒ†ãƒƒãƒ—ã®ã¿ã‚’ãƒ•ã‚£ãƒ«ã‚¿ï¼ˆè£œé–“ã¯é™¤å¤–ï¼‰
+    const realStepsForStride = finalSteps.filter(s => !s.isInterpolated && Number.isFinite(s.distanceAtContact));
     
     // globalDistã§ã‚½ãƒ¼ãƒˆï¼ˆæ™‚ç³»åˆ—é †ï¼‰
-    allStepsForStride.sort((a, b) => (a.distanceAtContact || 0) - (b.distanceAtContact || 0));
+    realStepsForStride.sort((a, b) => (a.distanceAtContact || 0) - (b.distanceAtContact || 0));
     
-    console.log(`\nğŸ“Š All steps (including interpolated): ${allStepsForStride.length}`);
+    console.log(`\nğŸ“Š Real steps (excluding interpolated): ${realStepsForStride.length}`);
     console.log(`ğŸ“‹ Calculating TrueStride[i] = globalDist[i+1] - globalDist[i]\n`);
     
     // TrueStrideã‚’è¨ˆç®—ï¼ˆå„ã‚¹ãƒ†ãƒƒãƒ—ã§æ¬¡ã®æ¥åœ°ã¾ã§ã®è·é›¢ï¼‰
-    for (let i = 0; i < allStepsForStride.length; i++) {
-      const currentDist = allStepsForStride[i].distanceAtContact || 0;
-      const nextStep = allStepsForStride[i + 1];
+    for (let i = 0; i < realStepsForStride.length; i++) {
+      const currentDist = realStepsForStride[i].distanceAtContact || 0;
+      const nextStep = realStepsForStride[i + 1];
       const nextDist = nextStep?.distanceAtContact;
-      const isInterpolated = allStepsForStride[i].isInterpolated === true;
       
       // ğŸ¯ ChatGPTè©³ç´°ãƒ­ã‚°
-      console.log(`[Step ${i}] ${isInterpolated ? '(interpolated)' : 'contactFrame=' + allStepsForStride[i].contactFrame}, segmentId=${allStepsForStride[i].segmentId ?? 'N/A'}`);
+      console.log(`[Step ${i}] contactFrame=${realStepsForStride[i].contactFrame}, segmentId=${realStepsForStride[i].segmentId ?? 'N/A'}`);
       console.log(`  contact_globalDist: ${currentDist.toFixed(3)}m`);
       
       if (nextDist != null) {
@@ -6881,18 +6851,18 @@ const handleNewMultiCameraStart = (run: Run, segments: RunSegment[]) => {
         // ç•°å¸¸å€¤ãƒ•ãƒ©ã‚°ï¼ˆ0.6mæœªæº€ã€2.2mè¶…ï¼‰
         if (trueStride < 0.6 || trueStride > 2.2) {
           console.warn(`  âš ï¸ strideAnomaly: true (unusual stride)`);
-          allStepsForStride[i].quality = 'warning'; // UIã§èµ¤ãè¡¨ç¤º
+          realStepsForStride[i].quality = 'warning'; // UIã§èµ¤ãè¡¨ç¤º
         }
         
         // ã‚¹ãƒˆãƒ©ã‚¤ãƒ‰ã‚’æ›´æ–°
-        allStepsForStride[i].stride = trueStride;
-        allStepsForStride[i].fullStride = trueStride;
+        realStepsForStride[i].stride = trueStride;
+        realStepsForStride[i].fullStride = trueStride;
         
         console.log(`  â†’ UPDATED stride to ${trueStride.toFixed(3)}m`);
       } else {
         console.log(`  â†’ Last step, no next contact`);
-        allStepsForStride[i].stride = null;
-        allStepsForStride[i].fullStride = undefined;
+        realStepsForStride[i].stride = null;
+        realStepsForStride[i].fullStride = undefined;
       }
     }
     
@@ -6905,10 +6875,7 @@ const handleNewMultiCameraStart = (run: Run, segments: RunSegment[]) => {
     // globalDistã§å†ã‚½ãƒ¼ãƒˆï¼ˆæ™‚ç³»åˆ—é †ã«æˆ»ã™ï¼‰
     finalSteps.sort((a, b) => (a.distanceAtContact || 0) - (b.distanceAtContact || 0));
     
-    const realCount = finalSteps.filter(s => !s.isInterpolated).length;
-    const interpolatedCount = finalSteps.filter(s => s.isInterpolated).length;
-    
-    console.log(`\nğŸ“Š Final steps after TrueStride recalculation: ${finalSteps.length} (real: ${realCount}, interpolated: ${interpolatedCount})`);
+    console.log(`\nğŸ“Š Final steps after TrueStride recalculation: ${finalSteps.length} (real: ${realStepsForStride.length}, interpolated: ${finalSteps.filter(s => s.isInterpolated).length})`);
     
     // ã‚°ãƒ­ãƒ¼ãƒãƒ«ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å†å‰²ã‚Šå½“ã¦
     finalSteps.forEach((step, idx) => {
-- 
2.39.5

